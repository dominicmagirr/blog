<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Dominic Magirr</title>
<link>https://dominicmagirr.github.io/blog/index.html</link>
<atom:link href="https://dominicmagirr.github.io/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>A blog about statistical methodology in clinical trials</description>
<generator>quarto-1.2.475</generator>
<lastBuildDate>Sat, 04 Oct 2025 22:00:00 GMT</lastBuildDate>
<item>
  <title>Variance estimation: ANCOVA RCT analysis</title>
  <dc:creator>Dominic Magirr</dc:creator>
  <link>https://dominicmagirr.github.io/blog/posts/variance_lm/variance_lm.html</link>
  <description><![CDATA[ 




<p>Consider a 2-arm RCT (1:1 allocation) with a continuous outcome, total sample size 200 and seven baseline covariates. Consider a superpopulation set-up. The estimand is the (super) population average treatment effect <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%20E(Y(1)%20-%20Y(0))">. Estimation is performed via a linear regression working model</p>
<p><img src="https://latex.codecogs.com/png.latex?E(Y_i%20%5Cmid%20A_i,%20X_%7B1,i%7D,%5Cldots,X_%7B7,i%7D)%20=%20%5Cbeta_0%20+%20%5Ctheta%20A_i%20+%20%5Cbeta_1%20X_%7B1,i%7D%20+%20%5Ccdots%20+%20%5Cbeta_7%7BX_%7B7,i%7D%7D"></p>
<p>so that <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Ctheta%7D"> is the usual least squares estimator of <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. For example,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">620</span>)</span>
<span id="cb1-2"></span>
<span id="cb1-3">n <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">200</span></span>
<span id="cb1-4">p <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">7</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## simulate covariates&nbsp;</span></span>
<span id="cb1-7">X_star <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">matrix</span>(<span class="fu" style="color: #4758AB;">rnorm</span>(n <span class="sc" style="color: #5E5E5E;">*</span> p), <span class="at" style="color: #657422;">nrow =</span> n, <span class="at" style="color: #657422;">ncol =</span> p)</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## equal allocation</span></span>
<span id="cb1-10">a <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), <span class="at" style="color: #657422;">each =</span> n <span class="sc" style="color: #5E5E5E;">/</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## design matrix</span></span>
<span id="cb1-13">X <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">cbind</span>(<span class="dv" style="color: #AD0000;">1</span>, a, X_star)</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## true parameter values</span></span>
<span id="cb1-16">beta <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.2</span>, <span class="fu" style="color: #4758AB;">rep</span>(<span class="fl" style="color: #AD0000;">0.1</span>, p))</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## simulate outcome</span></span>
<span id="cb1-19">y <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n, X<span class="sc" style="color: #5E5E5E;">%*%</span>beta)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## data set</span></span>
<span id="cb1-22">dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.data.frame</span>(<span class="fu" style="color: #4758AB;">cbind</span>(y, a, X_star))</span>
<span id="cb1-23">dat<span class="sc" style="color: #5E5E5E;">$</span>a <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.factor</span>(dat<span class="sc" style="color: #5E5E5E;">$</span>a)</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="do" style="color: #5E5E5E;
font-style: italic;">## fit model</span></span>
<span id="cb1-26">fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(y <span class="sc" style="color: #5E5E5E;">~</span> ., <span class="at" style="color: #657422;">data =</span> dat)</span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="do" style="color: #5E5E5E;
font-style: italic;">## point estimate theta_hat</span></span>
<span id="cb1-29">fit<span class="sc" style="color: #5E5E5E;">$</span>coef[<span class="dv" style="color: #AD0000;">2</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       a1 
0.1901536 </code></pre>
</div>
</div>
<p>How should we estimate the variance of <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Ctheta%7D">? One option is the usual ANCOVA approach,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Model based Var</span></span>
<span id="cb3-2">var_model <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">vcov</span>(fit)[<span class="st" style="color: #20794D;">"a1"</span>, <span class="st" style="color: #20794D;">"a1"</span>]</span>
<span id="cb3-3">var_model</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02338236</code></pre>
</div>
</div>
<p>Alternatively, we could use an influence function approach, as for example described in <a href="https://doi.org/10.1080/01621459.2022.2049278">Ye et al.&nbsp;(2023) “Toward Better Practice of Covariate Adjustment in Analyzing Randomized Clinical Trials”</a>, which has the endorsement of being included in <a href="https://www.fda.gov/regulatory-information/search-fda-guidance-documents/adjusting-covariates-randomized-clinical-trials-drugs-and-biological-products">recent FDA guidance</a>, and is implemented in <a href="https://openpharma.github.io/RobinCar2/main/">{RobinCar2}</a>,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">library</span>(RobinCar2)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'RobinCar2'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    table</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## RobinCar2 Var</span></span>
<span id="cb8-2">robin_fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">robin_lm</span>(<span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y ~ "</span>, <span class="fu" style="color: #4758AB;">paste0</span>(<span class="fu" style="color: #4758AB;">names</span>(dat)[<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>], <span class="at" style="color: #657422;">collapse =</span> <span class="st" style="color: #20794D;">"+"</span>))),</span>
<span id="cb8-3">                      <span class="at" style="color: #657422;">data =</span> dat,</span>
<span id="cb8-4">                      <span class="at" style="color: #657422;">treatment =</span> a <span class="sc" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">sp</span>(<span class="dv" style="color: #AD0000;">1</span>))</span>
<span id="cb8-5"></span>
<span id="cb8-6">var_robin <span class="ot" style="color: #003B4F;">&lt;-</span> robin_fit<span class="sc" style="color: #5E5E5E;">$</span>contrast<span class="sc" style="color: #5E5E5E;">$</span>variance[<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb8-7">var_robin</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01998412</code></pre>
</div>
</div>
<p>This estimated variance is 15% smaller than the usual ANCOVA variance estimate</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">var_robin <span class="sc" style="color: #5E5E5E;">/</span> var_model</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8546666</code></pre>
</div>
</div>
<p>Same model, same data, 15% smaller estimated variance.</p>
<section id="so-what" class="level2">
<h2 class="anchored" data-anchor-id="so-what">So what?</h2>
<p>The methods included in {RobinCar2} are powerful and useful. I’m an advocate for using more covariate adjustment in the primary analysis of RCTs. I’m especially excited about the methods for <a href="https://academic.oup.com/biomet/article-pdf/111/2/691/57467434/asad045.pdf">covariate adjustment involving time-to-event outcomes</a>. They need to be used in the appropriate settings, however.</p>
<p>It’s easy to say that’s when <img src="https://latex.codecogs.com/png.latex?p"> is not too large, and <img src="https://latex.codecogs.com/png.latex?n"> is not too small. I chose this example to be somewhere on the boundary of what I would instinctively consider reasonable but can still lead to a dramatic difference between the model-based and influence function approaches.</p>
<p>I’m slowly building an understanding of what’s driving this difference. It’s a combination of several factors: conditional vs unconditional inference, variance inflation factors <a href="https://arxiv.org/pdf/2408.06760">(see Senn et al.,2024)</a>, and a degrees of freedom correction. In large(ish) sample sizes each of these factors might not seem to make a huge difference in isolation, but together it could add up to a big difference.</p>


</section>

 ]]></description>
  <category>RCT</category>
  <guid>https://dominicmagirr.github.io/blog/posts/variance_lm/variance_lm.html</guid>
  <pubDate>Sat, 04 Oct 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Causal interpretation of the hazard ratio in RCTs</title>
  <dc:creator>Dominic Magirr</dc:creator>
  <link>https://dominicmagirr.github.io/blog/posts/causal_hr/causal_hr.html</link>
  <description><![CDATA[ 




<section id="motivation" class="level1">
<h1>Motivation</h1>
<p>A new set of articles on the “Causal interpretation of the hazard ratio in randomized clinical trials” ( <a href="https://doi.org/10.1177/17407745241243308">original article</a>, <a href="https://doi.org/10.1177/17407745241243307">commentary</a>, <a href="https://doi.org/10.1177/17407745241243311">response</a>) has pushed me to write this blogpost. It’s something I’ve been considering for a while, not because it’s the most important thing in the world, but there seems to be a persistent confusion, despite some <a href="https://thestatsgeek.com/2018/02/06/causal-interpretation-of-the-hazard-ratio-from-rcts-when-proportional-hazards-holds/">great attempts to clarify</a></p>
</section>
<section id="source-of-the-confusion" class="level1">
<h1>Source of the confusion</h1>
<p>The mistake (in my eyes) is to claim something like “the hazard ratio is not a causal effect” (in the context of an RCT) without first providing a precise definition of “causal effect”.</p>
</section>
<section id="definition-a" class="level1">
<h1>Definition A</h1>
<p>One clean and precise definition of a causal effect is provided by Hernan &amp; Robins <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">Technical Point 1.1</a>…</p>
<p><em>In general, a population causal effect can be defined as a contrast of any functional of the marginal distributions of counterfactual outcomes under different actions or treatment values.</em></p>
<p>The hazard ratio, <img src="https://latex.codecogs.com/png.latex?hr(t)">, satisfies this definition, for any choice of <img src="https://latex.codecogs.com/png.latex?t">. Therefore, if we follow this definition, then the hazard ratio is a causal effect. End of story. We can all move on.</p>
</section>
<section id="criticism-of-hazard-ratios-in-loose-language" class="level1">
<h1>Criticism of hazard ratios in loose language</h1>
<p><a href="https://journals.lww.com/epidem/fulltext/2010/01000/The_Hazards_of_Hazard_Ratios.4.aspx?trk=public_post_comment-text">“The hazards of hazard ratios” (Hernan, 2010)</a> contains an example where the hazard ratio (hormone therapy vs control) after 5 years is less than 1 “even if hormone therapy has no truly preventive effect in any woman at any time.”</p>
<p>Interestingly, though, the fact that a hazard ratio can ostensibly point in favour of an experimental treatment despite no true benefit is not the grounds given for claiming that a hazard ratio lacks a causal interpretation. For example, the so-called <a href="https://doi.org/10.1002/sim.8471">“total effect” in a competing risks setting</a> also has the property that it can be less than 1 (if it’s a ratio) despite no true benefit. Yet this is unequivocally a causal effect according to the authors.</p>
<p>Rather, the grounds given for claiming the hazard ratio is not a causal effect is always given in loose language, e.g., it somehow does not compare equal groups, or has a so-called <a href="https://academic.oup.com/eurheartj/advance-article-pdf/doi/10.1093/eurheartj/ehy770/46637053/ehy770.pdf?casa_token=epq6jgF2ZvIAAAAA:Uw86S5iQCVUvjikBaIHN-Gtcax9zYFOkThX6ZvnnhBNwh2Slduhy9xrZ5FYB9qSYjVuANL8Hc_dLUQ">“in-built selection bias”</a>. This is ambiguous. I would say that a hazard ratio at 5 years is a consequence of everything that happens to everyone in the first 5 years. It is not merely a comparison of the set of patients alive at 5 years, as if the patients who have died had never existed.</p>
</section>
<section id="definition-b" class="level1">
<h1>Definition B</h1>
<p>I’ve not seen a precise definition of a causal effect that would rule out the hazard ratio, so I’ll make one up here…</p>
<p><em>In general, a population causal effect can be defined as a contrast of any functional <strong>(except for a conditional expectation where the conditioning is on a post-baseline event)</strong> of the marginal distributions of counterfactual outcomes under different actions or treatment values.</em></p>
<p>If we follow this definition, then the hazard ratio is not (in general) a causal effect. End of story. We can all move on.</p>
<p>The reason for “in general” is that if the hazard ratio happens to be constant over time then it coincides with the difference in survival curves on the complimentary log log scale, which is an unconditional expectation.</p>
</section>
<section id="which-definition-is-better" class="level1">
<h1>Which definition is better?</h1>
<p>Given that both the hazard ratio and total effect have the same property that they can be less than 1 despite no true benefit, I prefer Definition A to Definition B.</p>
<p>Both the hazard ratio and the total effect require deep thought to understand. Neither has a straightforward interpretation. To use definition B, and therefore make the distinction that the total effect is causal and the hazard ratio in not causal, is a pure technicality in my eyes.</p>


</section>

 ]]></description>
  <category>Causal inference</category>
  <guid>https://dominicmagirr.github.io/blog/posts/causal_hr/causal_hr.html</guid>
  <pubDate>Fri, 10 May 2024 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Simulate from a Normal-inverse-Wishart distribution</title>
  <dc:creator>Dominic Magirr</dc:creator>
  <link>https://dominicmagirr.github.io/blog/posts/normal_inverse_wishart/index.html</link>
  <description><![CDATA[ 




<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The problem</h2>
<ul>
<li><p>Given some data which I assume is multivariate Gaussian, I’d like to simulate from the posterior distribution of the model parameters.</p></li>
<li><p>The conjugate Bayesian analysis is a <a href="https://en.wikipedia.org/wiki/Normal-inverse-Wishart_distribution">Normal-inverse-Wishart distribution</a>.</p></li>
<li><p>I’d like to do this very quickly based on snippets from wikipedia, rather than thinking much about it.</p></li>
</ul>
</section>
<section id="snippets-from-wikipedia" class="level2">
<h2 class="anchored" data-anchor-id="snippets-from-wikipedia">Snippets from wikipedia</h2>
<p>Here is the first snippet…</p>
<blockquote class="blockquote">
<p>To sample from the joint posterior of <img src="https://latex.codecogs.com/png.latex?(%5Cmu,%20%5CSigma)">, one simply draws samples from <img src="https://latex.codecogs.com/png.latex?%5CSigma%20%5Cmid%20y%20%5Csim%20W%5E%7B-1%7D(%5CPsi_n,%20%5Cnu_n)">, then draw <img src="https://latex.codecogs.com/png.latex?%5Cmu%20%5Cmid%20%5CSigma,%20y%20%5Csim%20N_p(%5Cmu_n,%20%5CSigma%20/%20%5Clambda_n)">, where</p>
</blockquote>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmu_n%20=%20%5Cfrac%7B%5Clambda%5Cmu_0+n%5Cbar%7By%7D%7D%7B%5Clambda%20+%20n%7D"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Clambda_n%20=%20%5Clambda%20+%20n"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cnu_n%20=%20%5Cnu%20+%20n"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5CPsi_n%20=%20%5CPsi%20+%20S%20+%20%5Cfrac%7B%5Clambda%20n%7D%7B%5Clambda%20+%20n%7D(%5Cbar%7By%7D-%5Cmu_0)(%5Cbar%7By%7D-%5Cmu_0)%5ET"></p>
<p>where</p>
<p><img src="https://latex.codecogs.com/png.latex?S%20=%20%5Csum_%7Bi=1%7D%5En%20%20(y_i%20-%5Cbar%7By%7D)(y_i%20-%20%5Cbar%7By%7D)%5ET."></p>
<p>Ok, so this assumes we have used a prior distribution:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5CSigma%20%5Csim%20W%5E%7B-1%7D(%5CPsi,%20%5Cnu)"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmu%20%5Cmid%20%5CSigma%20%5Csim%20N(%5Cmu_0,%20%5CSigma/%5Clambda)"></p>
<p>I don’t want to think too hard about prior distributions, even though that’s dangerous. It isn’t the point of this exercise. I want <img src="https://latex.codecogs.com/png.latex?%5Cmu_0">, <img src="https://latex.codecogs.com/png.latex?%5Clambda">, <img src="https://latex.codecogs.com/png.latex?%5Cnu"> and <img src="https://latex.codecogs.com/png.latex?%5CPsi"> to be small. Let’s just say zero for now, even if that’s a terrible idea. This way I’ve reduced the problem to drawing samples from <img src="https://latex.codecogs.com/png.latex?%5CSigma%20%5Cmid%20y%20%5Csim%20W%5E%7B-1%7D(S,%20n)">, then <img src="https://latex.codecogs.com/png.latex?%5Cmu%20%5Cmid%20%5CSigma,%20y%20%5Csim%20N_p(%5Cbar%7By%7D,%20%5CSigma%20/%20n)">.</p>
<p>The second snippet <a href="https://en.wikipedia.org/wiki/Inverse-Wishart_distribution">(from a different page)</a> is…</p>
<blockquote class="blockquote">
<p>If <img src="https://latex.codecogs.com/png.latex?X%5Csim%20W(%5CSigma,%20%5Cnu)">, then <img src="https://latex.codecogs.com/png.latex?A%20=%20X%5E%7B-1%7D"> has an inverse-Wishart distribution <img src="https://latex.codecogs.com/png.latex?A%20%5Csim%20W%5E%7B-1%7D(%5CSigma%5E%7B-1%7D,%20%5Cnu)."></p>
</blockquote>
<p>Ok, so this is mixing up notation now. Our target in our original notation is <img src="https://latex.codecogs.com/png.latex?%5CSigma%20%5Cmid%20y%20%5Csim%20W%5E%7B-1%7D(S,%20n)">. This snippet says we can achieve that by simulating <img src="https://latex.codecogs.com/png.latex?X"> from a Wishart distribution <img src="https://latex.codecogs.com/png.latex?X%5Csim%20W(S%5E%7B-1%7D,%20n)">, and then taking <img src="https://latex.codecogs.com/png.latex?%5CSigma%20=%20X%5E%7B-1%7D">.</p>
</section>
<section id="example-in-r" class="level2">
<h2 class="anchored" data-anchor-id="example-in-r">Example in R</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;"># simulate some 3-dimensional normal data, n = 20</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">n <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">20</span></span>
<span id="cb1-4"></span>
<span id="cb1-5">Y <span class="ot" style="color: #003B4F;">&lt;-</span> mvtnorm<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">rmvnorm</span>(<span class="at" style="color: #657422;">n =</span> n,</span>
<span id="cb1-6"></span>
<span id="cb1-7">                      <span class="at" style="color: #657422;">mean =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">180</span>, <span class="dv" style="color: #AD0000;">190</span>, <span class="dv" style="color: #AD0000;">200</span>),</span>
<span id="cb1-8"></span>
<span id="cb1-9">                      <span class="at" style="color: #657422;">sigma =</span> <span class="fu" style="color: #4758AB;">matrix</span>(<span class="dv" style="color: #AD0000;">70</span>, <span class="dv" style="color: #AD0000;">3</span>, <span class="dv" style="color: #AD0000;">3</span>) <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">diag</span>(<span class="dv" style="color: #AD0000;">30</span>, <span class="dv" style="color: #AD0000;">3</span>))</span>
<span id="cb1-10"></span>
<span id="cb1-11"> </span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;"># calculate Y_bar and S</span></span>
<span id="cb1-14"></span>
<span id="cb1-15">Y_bar <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">colMeans</span>(Y)</span>
<span id="cb1-16"></span>
<span id="cb1-17">S <span class="ot" style="color: #003B4F;">&lt;-</span> (<span class="fu" style="color: #4758AB;">t</span>(Y) <span class="sc" style="color: #5E5E5E;">-</span> Y_bar) <span class="sc" style="color: #5E5E5E;">%*%</span> <span class="fu" style="color: #4758AB;">t</span>(<span class="fu" style="color: #4758AB;">t</span>(Y) <span class="sc" style="color: #5E5E5E;">-</span> Y_bar)</span>
<span id="cb1-18"></span>
<span id="cb1-19"> </span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;"># simulate from inverse-Wishart distribution</span></span>
<span id="cb1-22"></span>
<span id="cb1-23">X <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rWishart</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">df =</span> n, <span class="at" style="color: #657422;">Sigma =</span> <span class="fu" style="color: #4758AB;">solve</span>(S))</span>
<span id="cb1-24"></span>
<span id="cb1-25">Sigma <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">solve</span>(X[,,<span class="dv" style="color: #AD0000;">1</span>])</span>
<span id="cb1-26"></span>
<span id="cb1-27">Sigma</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]     [,3]
[1,] 101.98658  78.70226 77.46274
[2,]  78.70226 104.04191 74.81375
[3,]  77.46274  74.81375 98.78784</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## simulate from normal distribution</span></span>
<span id="cb3-2"></span>
<span id="cb3-3">mu <span class="ot" style="color: #003B4F;">&lt;-</span> mvtnorm<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">rmvnorm</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">mean =</span> Y_bar, <span class="at" style="color: #657422;">sigma =</span> Sigma <span class="sc" style="color: #5E5E5E;">/</span> n)</span>
<span id="cb3-4"></span>
<span id="cb3-5">mu</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         [,1]     [,2]     [,3]
[1,] 180.9995 191.0862 201.4866</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <guid>https://dominicmagirr.github.io/blog/posts/normal_inverse_wishart/index.html</guid>
  <pubDate>Mon, 07 Aug 2023 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Covariate adjustment in RCTs: should we condition on baseline observations?</title>
  <dc:creator>Dominic Magirr</dc:creator>
  <link>https://dominicmagirr.github.io/blog/posts/conditional_inference/index.html</link>
  <description><![CDATA[ 




<section id="to-condition-or-not-part-1" class="level1">
<h1>To condition or not? (Part 1)</h1>
<p>Consider a randomized controlled trial (RCT) with patients <img src="https://latex.codecogs.com/png.latex?i=1,...,%20N">, randomized to treatment <img src="https://latex.codecogs.com/png.latex?A_i%20=%201"> or <img src="https://latex.codecogs.com/png.latex?A_i=0"> with probability <img src="https://latex.codecogs.com/png.latex?1/2">. Suppose there is a continuous outcome <img src="https://latex.codecogs.com/png.latex?Y_i">.</p>
<p>Should we perform inference conditional on the observed <img src="https://latex.codecogs.com/png.latex?A">? For example, are we more interested in a confidence interval <img src="https://latex.codecogs.com/png.latex?CI_%7BA%7D"> for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> (a treatment effect, say) such that</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Ctheta%20%5Cin%20CI_A%20%5Cmid%20A)%20=%201%20-%20%5Calpha%20?"></p>
<p>Or would we prefer to not condition on <img src="https://latex.codecogs.com/png.latex?A">, and aim for a confidence interval <img src="https://latex.codecogs.com/png.latex?CI"> such that</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Ctheta%20%5Cin%20CI)%20=%201%20-%20%5Calpha%20"> across multiple realizations of the experiment, each with different <img src="https://latex.codecogs.com/png.latex?A">’s.</p>
<p>As a concrete example, for a simple Gaussian model with known variance <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2">, suppose <img src="https://latex.codecogs.com/png.latex?N=500"> but we end up with <img src="https://latex.codecogs.com/png.latex?N_1=%20230"> and <img src="https://latex.codecogs.com/png.latex?N_0=%20270">. Do we prefer to estimate the variance of the difference-in-means estimator via</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Csigma%5E2%7D%7B230%7D%20+%20%5Cfrac%7B%5Csigma%5E2%7D%7B270%7D"></p>
<p>or via</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Csigma%5E2%7D%7B250%7D%20+%20%5Cfrac%7B%5Csigma%5E2%7D%7B250%7D%20?"></p>
<p>I think it’s fair to say that a majority would prefer the first option, i.e., conditional on <img src="https://latex.codecogs.com/png.latex?A">.</p>
</section>
<section id="to-condition-or-not-part-2" class="level1">
<h1>To condition or not? (Part 2)</h1>
<p>Now suppose there is a continuous, prognostic, baseline covariate <img src="https://latex.codecogs.com/png.latex?X_i">. Should we perform inference conditional on the observed <img src="https://latex.codecogs.com/png.latex?(A,X)">? For example, should we seek a confidence interval <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> such that</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Ctheta%20%5Cin%20CI_%7BA,X%7D%20%5Cmid%20A,%20X)%20=%201%20-%20%5Calpha%20"> rather than a confidence interval <img src="https://latex.codecogs.com/png.latex?CI_A"> such that</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Ctheta%20%5Cin%20CI_%7BA%7D%20%5Cmid%20A)%20=%201%20-%20%5Calpha%20?"></p>
<p>Undoubtedly, this is a harder question. There are at least two variants of it, depending on whether or not <img src="https://latex.codecogs.com/png.latex?X"> is used in the construction of <img src="https://latex.codecogs.com/png.latex?CI_A">.</p>
<p>The first variant, where <img src="https://latex.codecogs.com/png.latex?X"> is completely ignored in the construction of <img src="https://latex.codecogs.com/png.latex?CI_A">, has, I think, been comprehensively dealt with, for example by Stephen Senn in his <a href="https://onlinelibrary.wiley.com/doi/pdf/10.1002/sim.5713?casa_token=PP3JuqTFJd8AAAAA:kmx4NizbwzLw84KmVsuJKTGRbJKACKQ9gLnuzA62H8x8ZKUt8st30XTJVRPGPpCkpPyTRqygnaeI8g">Seven Myths about Randomization</a>. Having read that article, no one could possibly argue it’s ok to completely ignore <img src="https://latex.codecogs.com/png.latex?X"> in this situation.</p>
<p><em>Of course, if there are multiple prognostic baseline covariates, then it may not be practical to condition on all of them. But this is not the direction I want to go in this blog post. I’d rather stick with the single covariate and try to address the second variant of the question.</em></p>
<p>The second variant of the question, where <img src="https://latex.codecogs.com/png.latex?X"> is used in the construction of <img src="https://latex.codecogs.com/png.latex?CI_A"> but we still seek inference conditional on <img src="https://latex.codecogs.com/png.latex?A"> but not <img src="https://latex.codecogs.com/png.latex?X">, is far less important than the first. In fact, the intervals <img src="https://latex.codecogs.com/png.latex?CI_A"> and <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> may even be identical, with only the interpretation different.</p>
<p>Nevertheless, it’s still a question that bugs me. And it does have some, albeit minor, practical consequences.</p>
</section>
<section id="the-argument-for-preferring-ci_a-over-ci_ax" class="level1">
<h1>The argument for preferring <img src="https://latex.codecogs.com/png.latex?CI_A"> over <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"></h1>
<p>Suppose I fit an ANCOVA model <img src="https://latex.codecogs.com/png.latex?Y_i%20%5Csim%20N(%5Cbeta_0%20+%20%5Cbeta_1%20A_i%20+%20%5Cbeta_2%20X_i,%20%5Csigma%5E2)."> In this case, suppose both <img src="https://latex.codecogs.com/png.latex?CI_A"> and <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> are just the standard confidence interval for <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1">.</p>
<p>When I try to make a statement</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Cbeta_1%20%5Cin%20CI_%7BA,X%7D%20%5Cmid%20A,%20X)%20=%201%20-%20%5Calpha%20"></p>
<p>I am relying on the correctness of the model. This is true whether I interpret <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> as a conditional treatment effect that is identical across <img src="https://latex.codecogs.com/png.latex?X">, or as the marginal treatment effect <img src="https://latex.codecogs.com/png.latex?E(Y%5Cmid%20A%20=%201)%20-%20E(Y%5Cmid%20A%20=%200)">.</p>
<p>On the other hand, when I interpret <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> as the marginal treatment effect and make a statement</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Cbeta_1%20%5Cin%20CI_A%20%5Cmid%20A)%20=%201%20-%20%5Calpha"> then this does not rely on the correctness of the ANCOVA model, in large samples at least (see e.g., <a href="https://thestatsgeek.com/2019/04/29/ancova-in-rcts-model-based-standard-errors-are-valid-even-under-misspecification/">here</a>).</p>
<p><em>I’m taking for granted here that we’d always agree, at a minimum, to assume that <img src="https://latex.codecogs.com/png.latex?(A_i,%20X_i,%20Y_i)"> are i.i.d. random variables with some (possibly unspecified) reasonable joint distribution <img src="https://latex.codecogs.com/png.latex?f">. We might try to link <img src="https://latex.codecogs.com/png.latex?f"> to the real world by imagining we take a random sample of patients from an infinite </em> <strong><em>super population</em></strong> <em>and then randomly assign treatment. But of course we do not really take a random sample. And I’m not exactly sure what a </em> <strong><em>super population</em></strong> <em>is.</em></p>
</section>
<section id="the-argument-for-preferring-ci_ax-over-ci_a" class="level1">
<h1>The argument for preferring <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> over <img src="https://latex.codecogs.com/png.latex?CI_A"></h1>
<p>The preceding argument in favour of <img src="https://latex.codecogs.com/png.latex?CI_A"> seems fairly straightforward. It didn’t take me long to write down. To speak in favour of <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> requires getting more philosophical.</p>
<p><em>This is probably a good point to mention the </em> <a href="https://en.wikipedia.org/wiki/Conditionality_principle#:~:text=The%20conditionality%20principle%20is%20a,actually%20performed%20are%20statistically%20irrelevant."><strong><em>conditionality principle.</em></strong></a> <em>Obviously, the type of question I’m asking here is far from new. It has been discussed extensively by many experts starting decades ago, e.g., <a href="https://www.jstor.org/stable/2958922">here</a>, <a href="https://www.tandfonline.com/doi/pdf/10.1080/01621459.2000.10474344?casa_token=wd8U_QIuh5sAAAAA:aKTCTl3YqZum4GF9Gt5rUT6tI3jbZ4hlBtGRJVcS2dfk1mfTLC5O_oRpjVQMPD-TFH4K7QOhwceq">here</a>, <a href="https://books.google.ch/books?hl=en&amp;lr=&amp;id=7fz8JGLmWbgC&amp;oi=fnd&amp;pg=PA3&amp;dq=berger+wolpert+1988&amp;ots=iWqqYIhz0_&amp;sig=p0cWQsAt--p_3-SHzrUd0J2RmR0&amp;redir_esc=y#v=onepage&amp;q=berger%20wolpert%201988&amp;f=false">here</a> and many more. Even my specific question relative to RCTs has received a lot of attention. <a href="https://www.stat.ubc.ca/~john/papers/LiuSIM2009.pdf">This</a> is a good example, among many others. I’d highly recommend reading this work rather than anything I’m about to write.</em></p>
<p>In a nutshell, an analyst providing us with a confidence interval <img src="https://latex.codecogs.com/png.latex?CI_A"> asks us in some sense (which I’ll explain with an example below) to <em>pretend</em> that we haven’t seen <img src="https://latex.codecogs.com/png.latex?X">. They (the analyst) have seen it and used it, but we (the consumer) have to pretend we haven’t in order to claim (with a clear conscience) the robustness property described above.</p>
</section>
<section id="example" class="level1">
<h1>Example</h1>
<p>Suppose <img src="https://latex.codecogs.com/png.latex?N%20=%20600"> and the distribution of <img src="https://latex.codecogs.com/png.latex?X"> in the super population is <img src="https://latex.codecogs.com/png.latex?N(0,1)">. Suppose in our particular RCT the observed (A, X) was as follows…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">302</span>)</span>
<span id="cb1-2">x_fixed_1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">600</span>)</span>
<span id="cb1-3">a_fixed_1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rbinom</span>(<span class="dv" style="color: #AD0000;">600</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0.5</span>)</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">plot</span>(<span class="fu" style="color: #4758AB;">factor</span>(a_fixed_1), x_fixed_1,</span>
<span id="cb1-6">     <span class="at" style="color: #657422;">xlab =</span> <span class="st" style="color: #20794D;">"Treatment"</span>,</span>
<span id="cb1-7">     <span class="at" style="color: #657422;">ylab =</span> <span class="st" style="color: #20794D;">"X"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://dominicmagirr.github.io/blog/posts/conditional_inference/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now suppose the outcome model is</p>
<p><img src="https://latex.codecogs.com/png.latex?Y_i%20%5Cmid%20X_i%20%5Csim%20N(900%20+%200%20A_i%20-%20%5Cexp(X_i%20+%204),%2060%5E2)"></p>
<p>So the treatment effect, conditional or marginal, is <img src="https://latex.codecogs.com/png.latex?0">.</p>
<p>We can plot <img src="https://latex.codecogs.com/png.latex?Y"> against <img src="https://latex.codecogs.com/png.latex?X"> for a single realization…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">y_ex <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">600</span>,</span>
<span id="cb2-2">              <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">900</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">exp</span>(x_fixed_1 <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">4</span>),</span>
<span id="cb2-3">              <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">60</span>)</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;">plot</span>(x_fixed_1[a_fixed_1 <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>], y_ex[a_fixed_1 <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>],</span>
<span id="cb2-6">     <span class="at" style="color: #657422;">xlab =</span> <span class="st" style="color: #20794D;">"X"</span>,</span>
<span id="cb2-7">     <span class="at" style="color: #657422;">ylab =</span> <span class="st" style="color: #20794D;">"Y"</span>)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;">points</span>(x_fixed_1[a_fixed_1 <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1</span>], y_ex[a_fixed_1 <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1</span>],</span>
<span id="cb2-10">       <span class="at" style="color: #657422;">col =</span> <span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://dominicmagirr.github.io/blog/posts/conditional_inference/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Under this ‘true’ model, we can check the coverage probability of <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D">…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sim_1_fixed <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(<span class="at" style="color: #657422;">dummy =</span> <span class="dv" style="color: #AD0000;">0</span>, </span>
<span id="cb3-2">                        x_fixed,</span>
<span id="cb3-3">                        a_fixed){</span>
<span id="cb3-4">  </span>
<span id="cb3-5">  y <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">600</span>,</span>
<span id="cb3-6">             <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">900</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">exp</span>(x_fixed <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">4</span>),</span>
<span id="cb3-7">             <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">60</span>)</span>
<span id="cb3-8"></span>
<span id="cb3-9">  dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">y =</span> y, <span class="at" style="color: #657422;">x =</span> x_fixed, <span class="at" style="color: #657422;">a =</span> a_fixed)</span>
<span id="cb3-10">  </span>
<span id="cb3-11">  fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(y <span class="sc" style="color: #5E5E5E;">~</span> a <span class="sc" style="color: #5E5E5E;">+</span> x, <span class="at" style="color: #657422;">data =</span> dat)</span>
<span id="cb3-12">  </span>
<span id="cb3-13">  ci <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">confint</span>(fit)[<span class="st" style="color: #20794D;">"a"</span>,]</span>
<span id="cb3-14">  </span>
<span id="cb3-15">}</span>
<span id="cb3-16"></span>
<span id="cb3-17">ci_list_1 <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1000</span>), sim_1_fixed, </span>
<span id="cb3-18">                        <span class="at" style="color: #657422;">x_fixed =</span> x_fixed_1,</span>
<span id="cb3-19">                        <span class="at" style="color: #657422;">a_fixed =</span> a_fixed_1)</span>
<span id="cb3-20"></span>
<span id="cb3-21">ci_mat_1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">do.call</span>(rbind, ci_list_1)</span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;"># check coverage</span></span>
<span id="cb3-24"><span class="fu" style="color: #4758AB;">mean</span>(ci_mat_1[,<span class="dv" style="color: #AD0000;">1</span>] <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> ci_mat_1[,<span class="dv" style="color: #AD0000;">2</span>] <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.819</code></pre>
</div>
</div>
<p>Far below a nominal 95%.</p>
<p>Conversely, if instead of conditioning on the observed <img src="https://latex.codecogs.com/png.latex?(A,%20X)">, we only condition on the observed <img src="https://latex.codecogs.com/png.latex?A">, we can confirm that the coverage of <img src="https://latex.codecogs.com/png.latex?CI_A"> is as expected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">sim_1_random <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(<span class="at" style="color: #657422;">dummy =</span> <span class="dv" style="color: #AD0000;">0</span>, a_fixed){</span>
<span id="cb5-2">  </span>
<span id="cb5-3">  x <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">600</span>)</span>
<span id="cb5-4">  y <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">600</span>,</span>
<span id="cb5-5">             <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">900</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">exp</span>(x <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">4</span>),</span>
<span id="cb5-6">             <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">60</span>)</span>
<span id="cb5-7"></span>
<span id="cb5-8">  dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">y =</span> y, <span class="at" style="color: #657422;">x =</span> x, <span class="at" style="color: #657422;">a =</span> a_fixed)</span>
<span id="cb5-9">  </span>
<span id="cb5-10">  fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(y <span class="sc" style="color: #5E5E5E;">~</span> a <span class="sc" style="color: #5E5E5E;">+</span> x, <span class="at" style="color: #657422;">data =</span> dat)</span>
<span id="cb5-11">  </span>
<span id="cb5-12">  ci <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">confint</span>(fit)[<span class="st" style="color: #20794D;">"a"</span>,]</span>
<span id="cb5-13">  </span>
<span id="cb5-14">}</span>
<span id="cb5-15"></span>
<span id="cb5-16">ci_r_list <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1000</span>), sim_1_random, <span class="at" style="color: #657422;">a_fixed =</span> a_fixed_1)</span>
<span id="cb5-17">ci_r_mat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">do.call</span>(rbind, ci_r_list)</span>
<span id="cb5-18"></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;"># check coverage</span></span>
<span id="cb5-20"><span class="fu" style="color: #4758AB;">mean</span>(ci_r_mat[,<span class="dv" style="color: #AD0000;">1</span>] <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> ci_r_mat[,<span class="dv" style="color: #AD0000;">2</span>] <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.954</code></pre>
</div>
</div>
<p>Now, going back to the conditional case, I created <img src="https://latex.codecogs.com/png.latex?(A,%20X)"> from a random seed of <code>302</code>. If, instead, I create <img src="https://latex.codecogs.com/png.latex?(A,X)"> with a random seed of <code>303</code> and check the conditional coverage probability again, I find that it is more than <img src="https://latex.codecogs.com/png.latex?95%5C%25">…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">303</span>)</span>
<span id="cb7-2">x_fixed_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">600</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4">ci_list_2 <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">1000</span>), sim_1_fixed, </span>
<span id="cb7-5">                        <span class="at" style="color: #657422;">x_fixed =</span> x_fixed_2,</span>
<span id="cb7-6">                        <span class="at" style="color: #657422;">a_fixed =</span> a_fixed_1)</span>
<span id="cb7-7"></span>
<span id="cb7-8">ci_mat_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">do.call</span>(rbind, ci_list_2)</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;"># check coverage</span></span>
<span id="cb7-11"><span class="fu" style="color: #4758AB;">mean</span>(ci_mat_2[,<span class="dv" style="color: #AD0000;">1</span>] <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> ci_mat_2[,<span class="dv" style="color: #AD0000;">2</span>] <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.973</code></pre>
</div>
</div>
<p>So the <img src="https://latex.codecogs.com/png.latex?95%5C%25"> coverage of <img src="https://latex.codecogs.com/png.latex?CI_A"> is based on a mixture of experiments with different <img src="https://latex.codecogs.com/png.latex?(A,%20X)">. For some <img src="https://latex.codecogs.com/png.latex?(A,X)">, e.g.&nbsp;when the seed is <code>302</code>, fewer than 95% of experiments will cover <img src="https://latex.codecogs.com/png.latex?0">, while for some other <img src="https://latex.codecogs.com/png.latex?(A,X)">, e.g., when the seed is <code>303</code>, more than 95% of experiments will cover <img src="https://latex.codecogs.com/png.latex?0">.</p>
<p>If we can see <img src="https://latex.codecogs.com/png.latex?(A,X)">, then we know which of these situations we are in.</p>
<p>Often, a betting analogy is used. If I were to use <img src="https://latex.codecogs.com/png.latex?CI_A"> as a basis to make bets about the true treatment effect, then, in principle at least, someone with access to the data could potentially make easy money from me. Of course, they don’t know the true outcome model. But they could take a look. Maybe they could fit a low-degree spline model, or whatever.</p>
<p>If access to <img src="https://latex.codecogs.com/png.latex?(A,X)"> were restricted then this kind of thing wouldn’t be possible. That’s what I meant above when saying we have to pretend we haven’t seen <img src="https://latex.codecogs.com/png.latex?X">.</p>
<section id="my-thoughts-on-this-example" class="level2">
<h2 class="anchored" data-anchor-id="my-thoughts-on-this-example">My thoughts on this example</h2>
<p>For me, neither <img src="https://latex.codecogs.com/png.latex?CI_A"> nor <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> feel satisfactory in this example. I guess this just shows that I like to condition, since there is nothing technically wrong with <img src="https://latex.codecogs.com/png.latex?CI_A">.</p>
<p>My takeaway is that we need to use a half-decent model. This may conflict with the need to pre-specify a primary analysis method in an RCT and we need to find a pragmatic way through that conflict. I don’t think <img src="https://latex.codecogs.com/png.latex?CI_A"> necessarily saves us from this.</p>
</section>
</section>
<section id="practical-consequences" class="level1">
<h1>Practical consequences</h1>
<p>First, while in the ANCOVA example described above, the intervals <img src="https://latex.codecogs.com/png.latex?CI_A"> and <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D"> would be identical, this is not the case in other situations, for example with binary endpoints. In these situations, one needs to make a deliberate choice about which framework to follow. There has been a lot of very impressive work on this recently, for example <a href="https://arxiv.org/abs/2302.10404">here</a>, but I think we need to discuss it a bit more.</p>
<p>Second, there’s the issue of how much importance to place on the robustness property described above for favouring <img src="https://latex.codecogs.com/png.latex?CI_A"> over <img src="https://latex.codecogs.com/png.latex?CI_%7BA,X%7D">. Do we need to be very strict that our primary analysis methods give correct coverage conditional on <img src="https://latex.codecogs.com/png.latex?A"> but not <img src="https://latex.codecogs.com/png.latex?X">, regardless of model correctness? For example, I think this <a href="https://thestatsgeek.com/2023/06/23/is-the-ich-e9-estimand-addendum-compatible-with-model-based-estimands/">excellent presentation</a> by the <a href="https://thestatsgeek.com/about-thestatsgeek-com/">Stats Geek</a> heads a bit in this direction. (Note: another <a href="https://thestatsgeek.com/2018/11/20/comment-on-conditional-estimation-and-inference-to-address-observed-covariate-imbalance-in-randomized-clinical-trials/">great Stats Geek post</a> covers similar ground to what I’m discussing here).</p>
<p>I’d try to push back on that a little bit. On the one hand, I agree it’s nice to have this robustness property. If we used methods that grossly violated this, then that wouldn’t be good. However, for the reasons given in the example above, I don’t find it so appealing that I would use it in a strict way to categorise what is and isn’t acceptable.</p>
<p>As a concrete example, take the Cox model. It doesn’t matter which estimand one chooses (hazard ratio, difference in RMST, difference in milestone survival, etc.), if a Cox model is used then the type of robustness property described above will never hold. The correctness of the inference, whether conditional or marginal, is dependent on the correctness of the Cox model.</p>
<p>Does this disqualify the Cox model? I would argue not. We can still probe the robustness of the model (<a href="https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/">see my previous post</a>) and check for any big problems. Plus, of course, there’s the whole area of model checking once we have the data, although this obviously has its own challenges.</p>


</section>

 ]]></description>
  <category>news</category>
  <guid>https://dominicmagirr.github.io/blog/posts/conditional_inference/index.html</guid>
  <pubDate>Fri, 14 Jul 2023 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Stratified or covariate adjusted Cox model?</title>
  <dc:creator>Dominic Magirr</dc:creator>
  <link>https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/index.html</link>
  <description><![CDATA[ 




<p>The European Medicines Agency recently released a <a href="https://www.ema.europa.eu/en/documents/other/letter-support-statistical-adjustment-deep-learning-prognosis-covariates-obtained-histological_en.pdf">letter of support</a> regarding covariate adjustment in RCTs with time-to-event endpoints.</p>
<p>I found it interesting, not because of the specific prognostic covariate in question, but rather the <strong>Discussion of statistical methodology</strong> section, where the more general question was addressed of whether a Cox model adjusting for <strong>any</strong> covariate is acceptable. To quote:</p>
<p><em>The simulation studies performed as outlined rely on the proportional hazard assumption. In case of non-proportional hazards there is the risk of a considerable increase in Type 1 error <a href="https://onlinelibrary.wiley.com/doi/epdf/10.1002/sim.3406">Jiang H et al.,(Stat Med (2008)</a> when using adjusted Cox regression […] The standard approach to analysis of time-to-event data in clinical trials in oncology is to use a log-rank test, with or without stratification factors, for hypothesis testing for a primary time-to-event endpoint. Cox Models with adjustment for covariates are only used for estimation of treatment effects.</em></p>
<p>In informal conversations with colleagues working in oncology over recent years, I’ve often heard that performing a stratified log-rank test is considered OK, but including a (continuous, say) covariate as an additional term in a Cox model, and then performing the primary hypothesis test via this model, would be dismissed out of hand.</p>
<p>I’ve wondered where this received wisdom comes from. My intuition was that, having made the assumptions necessary to perform the stratified log-rank test, it’s a relatively mild <em>additional</em> assumption to use the Cox model with the covariate as an additional term instead.</p>
<p>So I’m glad that this letter illuminates (perhaps) the source of this line of argument.</p>
<p>In <a href="https://onlinelibrary.wiley.com/doi/epdf/10.1002/sim.3406">Jiang H et al.,Stat Med (2008)</a>, the authors simulate survival times form a log-normal distribution…</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Clog(T)%20%5Csim%20N(-4%20+%200%20%5Ctimes%20Z_1%20-%200.15%20%5Ctimes%20Z_2%20%20,%201)."></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?Z_1"> is the treatment indicator, and <img src="https://latex.codecogs.com/png.latex?Z_2"> is a covariate with distribution <img src="https://latex.codecogs.com/png.latex?N(%5Cmu%20=%2050,%20%5Csigma%5E2%20=%20100)">.</p>
<p>A Cox model <img src="https://latex.codecogs.com/png.latex?h(t)%20=%20h_0(t)%5Cexp(%5Cbeta_1%20Z_1%20+%20%5Cbeta_2%20Z_2)"> is used for analysis with a test based on the estimated <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cbeta%7D_1">.</p>
<section id="case-1-no-censoring" class="level2">
<h2 class="anchored" data-anchor-id="case-1-no-censoring">Case 1: no censoring</h2>
<p><a href="https://onlinelibrary.wiley.com/doi/epdf/10.1002/sim.3406">Jiang H et al.,Stat Med (2008)</a> claim that the two-sided type I error rate increases from nominal 5% to about 10%. I’ll reproduce that here (although I’ll show the one-sided alpha increases from 2.5% to about 5%)…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(survival)</span>
<span id="cb1-2"> </span>
<span id="cb1-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## function to simulate data from one trial,</span></span>
<span id="cb1-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## fit Cox model, and estimate adjusted hazard</span></span>
<span id="cb1-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ratio (treatment effect, beta_1)</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">sim_one_trial <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(n, <span class="at" style="color: #657422;">beta_0 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">4</span>, <span class="at" style="color: #657422;">beta_2 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.15</span>){</span>
<span id="cb1-8"></span>
<span id="cb1-9">  z_1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"c"</span>, <span class="st" style="color: #20794D;">"e"</span>), <span class="at" style="color: #657422;">each =</span> n)</span>
<span id="cb1-10">  z_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> n, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">50</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb1-11">  t_c_e <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">exp</span>(<span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> n, <span class="at" style="color: #657422;">mean =</span> beta_0 <span class="sc" style="color: #5E5E5E;">+</span> beta_2 <span class="sc" style="color: #5E5E5E;">*</span> z_2))</span>
<span id="cb1-12">  events <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> n)</span>
<span id="cb1-13"></span>
<span id="cb1-14">  fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">coxph</span>(<span class="fu" style="color: #4758AB;">Surv</span>(t_c_e, events) <span class="sc" style="color: #5E5E5E;">~</span>  z_1 <span class="sc" style="color: #5E5E5E;">+</span> z_2)</span>
<span id="cb1-15"></span>
<span id="cb1-16">  z <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;">$</span>coef[<span class="dv" style="color: #AD0000;">1</span>, <span class="st" style="color: #20794D;">"z"</span>]</span>
<span id="cb1-17">}</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## simulate 1000 trials, with n = 200 per arm</span></span>
<span id="cb1-20"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">325</span>)</span>
<span id="cb1-21">res <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map_dbl</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">200</span>, <span class="dv" style="color: #AD0000;">1000</span>), sim_one_trial)</span>
<span id="cb1-22"> </span>
<span id="cb1-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## estimate type I error rate</span></span>
<span id="cb1-24"><span class="fu" style="color: #4758AB;">mean</span>(res <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="fu" style="color: #4758AB;">qnorm</span>(<span class="fl" style="color: #AD0000;">0.025</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.054</code></pre>
</div>
</div>
<p>So that’s it then? This approach is a no-no?</p>
<p>Well…maybe. But first let’s take a closer look at this model and this particular parameter constellation. To do that I simulate 1,000 observations from the model, and then plot the Kaplan-Meier estimate…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">n <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb3-2">beta_0 <span class="ot" style="color: #003B4F;">=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">4</span></span>
<span id="cb3-3">beta_2 <span class="ot" style="color: #003B4F;">=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.15</span></span>
<span id="cb3-4">z_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">50</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb3-5">surv_t <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">exp</span>(<span class="fu" style="color: #4758AB;">rnorm</span>(n, <span class="at" style="color: #657422;">mean =</span> beta_0 <span class="sc" style="color: #5E5E5E;">+</span> beta_2 <span class="sc" style="color: #5E5E5E;">*</span> z_2))</span>
<span id="cb3-6">fit_km <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t, <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;">plot</span>(fit_km, <span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">FALSE</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This is a strange choice of time scale. But that’s not really important. I can multiply the survival times by 100,000 to get a more intuitive scale (years, say). Let’s try again…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">surv_t <span class="ot" style="color: #003B4F;">&lt;-</span> surv_t <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">100000</span></span>
<span id="cb4-2">fit_km <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t, <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;">plot</span>(fit_km, <span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">FALSE</span>, <span class="at" style="color: #657422;">xlim =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">10</span>),</span>
<span id="cb4-4">     <span class="at" style="color: #657422;">xlab =</span> <span class="st" style="color: #20794D;">"time (years)"</span>,</span>
<span id="cb4-5">     <span class="at" style="color: #657422;">ylab =</span> <span class="st" style="color: #20794D;">"P(Survival)"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The next thing I’ll do is plot the KM curve of patients with an above average covariate value, <img src="https://latex.codecogs.com/png.latex?Z_2%20%3E%2050">, versus those with a below average covariate value, <img src="https://latex.codecogs.com/png.latex?Z_2%20%3C%2050">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">below_50 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t[z_2 <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">50</span>], <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)[z_2 <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">50</span>]) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb5-2">above_50 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t[z_2 <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">50</span>], <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)[z_2 <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">50</span>]) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;">plot</span>(fit_km, <span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">FALSE</span>, <span class="at" style="color: #657422;">xlim =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">10</span>),</span>
<span id="cb5-4">     <span class="at" style="color: #657422;">xlab =</span> <span class="st" style="color: #20794D;">"time (years)"</span>,</span>
<span id="cb5-5">     <span class="at" style="color: #657422;">ylab =</span> <span class="st" style="color: #20794D;">"P(Survival)"</span>)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="fu" style="color: #4758AB;">points</span>(below_50<span class="sc" style="color: #5E5E5E;">$</span>time, below_50<span class="sc" style="color: #5E5E5E;">$</span>surv, <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"l"</span>, <span class="at" style="color: #657422;">col =</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb5-8"><span class="fu" style="color: #4758AB;">points</span>(above_50<span class="sc" style="color: #5E5E5E;">$</span>time, above_50<span class="sc" style="color: #5E5E5E;">$</span>surv, <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"l"</span>, <span class="at" style="color: #657422;">col =</span> <span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb5-9"><span class="fu" style="color: #4758AB;">legend</span>(<span class="st" style="color: #20794D;">"topright"</span>, <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"Z_2 &lt; 50"</span>, <span class="st" style="color: #20794D;">"Z_2 &gt; 50"</span>),</span>
<span id="cb5-10">       <span class="at" style="color: #657422;">lty =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">1</span>),</span>
<span id="cb5-11">       <span class="at" style="color: #657422;">col =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This shows that <img src="https://latex.codecogs.com/png.latex?Z_2"> is an enormously prognostic covariate. Let’s look at the <em>period-specific average hazard ratios</em> comparing “Z_2 &gt; 50” versus “Z_2 &lt; 50”, for the period [0, 1] years, and then for the period 1+ years…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## year 1</span></span>
<span id="cb6-2">group <span class="ot" style="color: #003B4F;">&lt;-</span> z_2 <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">50</span></span>
<span id="cb6-3">year_one_t <span class="ot" style="color: #003B4F;">&lt;-</span> surv_t</span>
<span id="cb6-4">year_one_event <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1000</span>)</span>
<span id="cb6-5">year_one_event[year_one_t <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>] <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb6-6">year_one_t[year_one_t <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>] <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="fu" style="color: #4758AB;">coxph</span>(<span class="fu" style="color: #4758AB;">Surv</span>(year_one_t, year_one_event) <span class="sc" style="color: #5E5E5E;">~</span> group)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(year_one_t, year_one_event) ~ group)

            coef exp(coef) se(coef)     z      p
groupTRUE 2.1509    8.5922   0.1171 18.36 &lt;2e-16

Likelihood ratio test=456.3  on 1 df, p=&lt; 2.2e-16
n= 1000, number of events= 494 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## beyond year 1</span></span>
<span id="cb8-2">group <span class="ot" style="color: #003B4F;">&lt;-</span> group[surv_t <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb8-3">beyond_one_t <span class="ot" style="color: #003B4F;">&lt;-</span> surv_t[surv_t <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb8-4">beyond_one_event <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1000</span>)[surv_t <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">1</span>]</span>
<span id="cb8-5"></span>
<span id="cb8-6"><span class="fu" style="color: #4758AB;">coxph</span>(<span class="fu" style="color: #4758AB;">Surv</span>(beyond_one_t, beyond_one_event) <span class="sc" style="color: #5E5E5E;">~</span> group)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(beyond_one_t, beyond_one_event) ~ group)

           coef exp(coef) se(coef)     z      p
groupTRUE 1.352     3.867    0.121 11.17 &lt;2e-16

Likelihood ratio test=98.73  on 1 df, p=&lt; 2.2e-16
n= 506, number of events= 506 </code></pre>
</div>
</div>
<p>Ok, so the average hazard ratio between these two groups is about 9 during the first year (where around half of the events occur), then the average hazard ratio is much lower (but still high) after year one.</p>
<p>That’s kind of extreme. Even an <a href="https://www.sciencedirect.com/science/article/pii/S1047279705003248">optimistic view of the benefits of covariate adjustment</a> only considers HRs between 2 and 5.</p>
<p>What happens when we change the parameter constellation so that <img src="https://latex.codecogs.com/png.latex?Z_2"> is still very strongly prognostic, but perhaps something a bit more reasonable? Something like this…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">n <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="dv" style="color: #AD0000;">1000</span></span>
<span id="cb10-2">beta_0 <span class="ot" style="color: #003B4F;">=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">4</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">0.075</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">50</span></span>
<span id="cb10-3">beta_2 <span class="ot" style="color: #003B4F;">=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.15</span> <span class="sc" style="color: #5E5E5E;">+</span> <span class="fl" style="color: #AD0000;">0.075</span></span>
<span id="cb10-4">z_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">50</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb10-5">surv_t <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">exp</span>(<span class="fu" style="color: #4758AB;">rnorm</span>(n, <span class="at" style="color: #657422;">mean =</span> beta_0 <span class="sc" style="color: #5E5E5E;">+</span> beta_2 <span class="sc" style="color: #5E5E5E;">*</span> z_2)) <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">100000</span></span>
<span id="cb10-6"></span>
<span id="cb10-7">fit_km <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t, <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb10-8">below_50 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t[z_2 <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">50</span>], <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)[z_2 <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="dv" style="color: #AD0000;">50</span>]) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb10-9">above_50 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">survfit</span>(<span class="fu" style="color: #4758AB;">Surv</span>(surv_t[z_2 <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">50</span>], <span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span>, n)[z_2 <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="dv" style="color: #AD0000;">50</span>]) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="fu" style="color: #4758AB;">plot</span>(fit_km, <span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">FALSE</span>, <span class="at" style="color: #657422;">xlim =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">10</span>))</span>
<span id="cb10-12"><span class="fu" style="color: #4758AB;">points</span>(below_50<span class="sc" style="color: #5E5E5E;">$</span>time, below_50<span class="sc" style="color: #5E5E5E;">$</span>surv, <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"l"</span>, <span class="at" style="color: #657422;">col =</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb10-13"><span class="fu" style="color: #4758AB;">points</span>(above_50<span class="sc" style="color: #5E5E5E;">$</span>time, above_50<span class="sc" style="color: #5E5E5E;">$</span>surv, <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"l"</span>, <span class="at" style="color: #657422;">col =</span> <span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb10-14"><span class="fu" style="color: #4758AB;">legend</span>(<span class="st" style="color: #20794D;">"topright"</span>, <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"Z_2 &lt; 50"</span>, <span class="st" style="color: #20794D;">"Z_2 &gt; 50"</span>),</span>
<span id="cb10-15">       <span class="at" style="color: #657422;">lty =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">1</span>),</span>
<span id="cb10-16">       <span class="at" style="color: #657422;">col =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">2</span>,<span class="dv" style="color: #AD0000;">3</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then, repeating the simulation to estimate the type 1 error rate…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">res <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map_dbl</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">200</span>, <span class="dv" style="color: #AD0000;">10000</span>), sim_one_trial,</span>
<span id="cb11-2">                      <span class="at" style="color: #657422;">beta_0 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">4</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">0.075</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">50</span>, <span class="at" style="color: #657422;">beta_2 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.15</span> <span class="sc" style="color: #5E5E5E;">+</span> <span class="fl" style="color: #AD0000;">0.075</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;">mean</span>(res <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="fu" style="color: #4758AB;">qnorm</span>(<span class="fl" style="color: #AD0000;">0.025</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0376</code></pre>
</div>
</div>
</section>
<section id="case-2-with-censoring" class="level2">
<h2 class="anchored" data-anchor-id="case-2-with-censoring">Case 2: with censoring</h2>
<p><a href="https://onlinelibrary.wiley.com/doi/epdf/10.1002/sim.3406">Jiang H et al.,Stat Med (2008)</a> show that with censoring rates of 20% and 40%, the type 1 error inflation is similar to the no censoring case.</p>
<p>However, their censoring mechanism is a competing exponential distribution. I don’t think this is realistic. Owing to the heavy tail of the log-normal distribution, these trials would carry on for decades.</p>
<p>Let’s repeat the simulations but with administrative censoring driven by a trial recruitment process that is uniform and lasts one year, plus a total trial duration of three years…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## function to simulate data from one trial,</span></span>
<span id="cb13-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## fit Cox model, and estimate adjusted hazard</span></span>
<span id="cb13-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ratio (treatment effect, beta_1)</span></span>
<span id="cb13-4">sim_one_trial_with_censoring <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(n, <span class="at" style="color: #657422;">beta_0 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">4</span>, <span class="at" style="color: #657422;">beta_2 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.15</span>,</span>
<span id="cb13-5">                                         <span class="at" style="color: #657422;">trial_duration =</span> <span class="fl" style="color: #AD0000;">3e-06</span>, <span class="at" style="color: #657422;">rec_duration =</span> <span class="fl" style="color: #AD0000;">1e-06</span>){</span>
<span id="cb13-6"></span>
<span id="cb13-7">  z_1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"c"</span>, <span class="st" style="color: #20794D;">"e"</span>), <span class="at" style="color: #657422;">each =</span> n)</span>
<span id="cb13-8">  z_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> n, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">50</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb13-9">  t_c_e <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">exp</span>(<span class="fu" style="color: #4758AB;">rnorm</span>(<span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> n, <span class="at" style="color: #657422;">mean =</span> beta_0 <span class="sc" style="color: #5E5E5E;">+</span> beta_2 <span class="sc" style="color: #5E5E5E;">*</span> z_2))</span>
<span id="cb13-10">  rec <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">runif</span>(<span class="dv" style="color: #AD0000;">2</span> <span class="sc" style="color: #5E5E5E;">*</span> n, <span class="dv" style="color: #AD0000;">0</span>, rec_duration)</span>
<span id="cb13-11">  events <span class="ot" style="color: #003B4F;">&lt;-</span> rec <span class="sc" style="color: #5E5E5E;">+</span> t_c_e <span class="sc" style="color: #5E5E5E;">&lt;</span> trial_duration</span>
<span id="cb13-12">  t_c_e[events <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>] <span class="ot" style="color: #003B4F;">&lt;-</span> (trial_duration <span class="sc" style="color: #5E5E5E;">-</span> rec)[events <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>]</span>
<span id="cb13-13"></span>
<span id="cb13-14">  fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">coxph</span>(<span class="fu" style="color: #4758AB;">Surv</span>(t_c_e, events) <span class="sc" style="color: #5E5E5E;">~</span>  z_1 <span class="sc" style="color: #5E5E5E;">+</span> z_2)</span>
<span id="cb13-15">  </span>
<span id="cb13-16">  z <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;">$</span>coef[<span class="dv" style="color: #AD0000;">1</span>, <span class="st" style="color: #20794D;">"z"</span>]</span>
<span id="cb13-17"></span>
<span id="cb13-18">}</span></code></pre></div>
</div>
<p>Firstly for the original (extreme) example…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## simulate 1000 trials, with n = 200 per arm</span></span>
<span id="cb14-2">res <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map_dbl</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">200</span>, <span class="dv" style="color: #AD0000;">10000</span>), sim_one_trial_with_censoring)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## estimate type I error rate</span></span>
<span id="cb14-5"><span class="fu" style="color: #4758AB;">mean</span>(res <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="fu" style="color: #4758AB;">qnorm</span>(<span class="fl" style="color: #AD0000;">0.025</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0461</code></pre>
</div>
</div>
<p>and then for the slightly more realistic one…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="do" style="color: #5E5E5E;
font-style: italic;">## simulate 1000 trials, with n = 200 per arm</span></span>
<span id="cb16-2"></span>
<span id="cb16-3">res <span class="ot" style="color: #003B4F;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">map_dbl</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">200</span>, <span class="dv" style="color: #AD0000;">10000</span>), sim_one_trial_with_censoring,</span>
<span id="cb16-4">                <span class="at" style="color: #657422;">beta_0 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">4</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">0.075</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">50</span>,</span>
<span id="cb16-5">                      <span class="at" style="color: #657422;">beta_2 =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="fl" style="color: #AD0000;">0.15</span> <span class="sc" style="color: #5E5E5E;">+</span> <span class="fl" style="color: #AD0000;">0.075</span>)</span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## estimate type I error rate</span></span>
<span id="cb16-8"><span class="fu" style="color: #4758AB;">mean</span>(res <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="fu" style="color: #4758AB;">qnorm</span>(<span class="fl" style="color: #AD0000;">0.025</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0287</code></pre>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>My intuition before writing this blogpost was that I wouldn’t be too concerned about type 1 error inflation when fitting a Cox model with a continuous covariate entering as a simple linear term, even when that model is inevitably wrong.</p>
<p>Have I changed my mind? Not yet. I’m guessing, with enough effort, someone could produce a realistic-looking example where there is a <em>considerable</em> increase in Type 1 error. But, in my opinion, the example cited by the EMA in their letter doesn’t provide that (it’s no slam dunk, at least).</p>


</section>

 ]]></description>
  <category>news</category>
  <guid>https://dominicmagirr.github.io/blog/posts/stratify_or_adjust/index.html</guid>
  <pubDate>Tue, 30 May 2023 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Old blog</title>
  <dc:creator>Dominic Magirr</dc:creator>
  <link>https://dominicmagirr.github.io/blog/posts/old-blog-posts/index.html</link>
  <description><![CDATA[ 




<p>Previous blogposts can be found <a href="https://dominicmagirr.github.io">here</a></p>



 ]]></description>
  <category>news</category>
  <guid>https://dominicmagirr.github.io/blog/posts/old-blog-posts/index.html</guid>
  <pubDate>Tue, 04 Apr 2023 22:00:00 GMT</pubDate>
</item>
</channel>
</rss>
